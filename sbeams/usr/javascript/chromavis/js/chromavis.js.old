

//intialize with var data ={DATATYPE : "vq.models.FlexPlotData", CONTENTS : {DATAARRAY : data_array} };
// notifier = function(x,dx) where x = position within scroll bar range,  dx = total length of window in scale of scroll bar

//draw with draw (data ={DATATYPE : "vq.models.FlexPlotData", {DATAARRAY : data_array} }
//				and options = {plotHeight: xx, plotWidth : xx, verticalPadding: xx, 
//				horizontalPadding : xx , max_x_axis_value: xx, min_x_axis_value: xx,
//				maxRange: xx, minRange: xx, dblclick_notifier : function(x,dx),
//				fixedWindowWidth: xx, scaleMultiplier : xx, interval : xx, font : "fontname"}
//note dblclick_notifer is the last listed option.  This can be used to create a "zoom" effect by re-instanstiating the scroll bar with new parameters.


vq.ChromaVis = function() {
    vq.Vis.call(this);

    //set option variables to useful values before options are set.
    this.height(500);     // defaults
    this.width(500);     // defaults
    this.vertical_padding(30);
    this.horizontal_padding(30);
    this.max_x_axis_value(11);
    this.min_x_axis_value(0);
    this.context_height(50);
    this.max_y_axis_value(1);
    this.min_y_axis_value(1);

};

vq.ChromaVis.prototype = pv.extend(vq.Vis);

vq.ChromaVis.prototype
        .property('max_x_axis_value',Number)
        .property('min_x_axis_value',Number)
        .property('max_y_axis_value',Number)
        .property('min_y_axis_value',Number)
        .property('auto_scale_y',Boolean)
        .property('auto_scale_x',Boolean)
        .property('auto_update_scale_y',Boolean)
        .property('context_height',Number);


vq.ChromaVis.prototype._setOptionDefaults =  function(options) {

    if (options.max_x_axis_value != null) { this.max_x_axis_value(options.max_x_axis_value); }

    if (options.min_x_axis_value != null) { this.min_x_axis_value(options.min_x_axis_value); }

    if (options.context_height != null) { this.context_height(options.context_height); }

    if (options.auto_scale_y != null) { this.auto_scale_y(options.auto_scale_y); }
    if (options.auto_scale_x != null) { this.auto_scale_x(options.auto_scale_x); }

    if (options.auto_update_scale_y != null) { this.auto_update_scale_y(options.auto_update_scale_y); }

    if (options.max_y_axis_value != null) { this.max_y_axis_value(options.max_y_axis_value); }
    if (options.min_y_axis_value != null) { this.min_y_axis_value(options.min_y_axis_value); }

    if (options.height != null) { this.height(options.height); }

    if (options.width != null) { this.width(options.width); }

    if (options.container) { this.container(options.container); }

    if (options.vertical_padding != null) { this.vertical_padding(options.vertical_padding); }

    if (options.horizontal_padding != null) { this.horizontal_padding(options.horizontal_padding); }

};

vq.ChromaVis.prototype.draw = function(data) {
    var that = this;


    this._bl_data = new vq.models.ChromaVisData(data);
    if (this._bl_data.isDataReady()) {
        this._setOptionDefaults(that._bl_data);
        this._render();
    }
};

vq.ChromaVis.prototype._render = function() {

    var that = this;
    var dataObj = this._bl_data;

    var x_label;

    this.show_vals = false;
    this.current_vals = {};
    that.mouse_x = null;

    this.visibleWidth = (this.width() - 2 * this.horizontal_padding() - dataObj.legend_width) - 40;  //40 is for y-axis label
    this.visibleHeight = (this.height() - this.vertical_padding() * 2);
    this.focus_height = this.visibleHeight - this.context_height();
    this.posX =  pv.Scale.linear().range(0,that.visibleWidth);


    var  min_x =  that.auto_scale_x()  ?
            pv.min(dataObj.data_array,function(a) { return pv.min(a[dataObj.data_contents_id],function(b) {return b[dataObj.x_column_id];});}):
            that.min_x_axis_value(),
         max_x =  that.auto_scale_x()  ?
            pv.max(dataObj.data_array,function(a) { return pv.max(a[dataObj.data_contents_id],function(b) {return b[dataObj.x_column_id];});}) :
            that.max_x_axis_value();

    that.min_x_axis_value(min_x);
    that.max_x_axis_value(max_x);


    this.context_posX = pv.Scale.linear(that.min_x_axis_value(), that.max_x_axis_value()).range(0,that.visibleWidth);
    that.window = {x:that.context_posX.range()[0],dx:(that.context_posX.range()[1] - that.context_posX.range()[0]) *.6};
    that.posX.domain(that.context_posX.invert(that.window.x),that.context_posX.invert(that.window.x + that.window.dx));
    that.focus_window = {x:0,dx:0};

    function update_vals() {
        var index = -1;
         that.show_vals = true;
         that.mouse_x = that.posX.invert(tracks_panel.mouse().x);
         dataObj.data_array.forEach(function(line) {
            index = pv.search(line[dataObj.data_contents_id].map(function(point) { return point[dataObj.x_column_id];}),that.mouse_x);
             index = index < 0 ? (-index -2) : index;
             if (index < 0) { that.show_vals = false;}
            that.current_vals[line[dataObj.data_label]]= index < 0 ? 0 : line[dataObj.data_contents_id][index][dataObj.y_column_id];
         });
        x_label.render();
        return legend;
    }

    function remove_vals() { that.show_vals = false; that.mouse_x = null; x_label.render(); return legend;}



    var     x = pv.Scale.linear(that.min_x_axis_value(),that.max_x_axis_value())
            .range(0,that.visibleWidth),
            scale_height = this.focus_height - 4,
//            min_val = that.auto_scale_y()  ?
//                    pv.min(dataObj.data_array,function(a) { return pv.min(a[dataObj.data_contents_id],function(b) {return b[dataObj.y_column_id];});}):
             min_val = that.min_y_axis_value(),

            max_val  = that.auto_scale_y()  ?
                    pv.max(dataObj.data_array,function(a) { return pv.max(a[dataObj.data_contents_id],function(b) {return b[dataObj.y_column_id];});}) :
                     this.max_y_axis_value(),
            yScale = pv.Scale.linear(min_val,max_val ).range(0,scale_height);
    dataObj.context_yScale = pv.Scale.linear(min_val,max_val ).range(0,that.context_height());

    this.max_y_axis_value(max_val);
    this.min_y_axis_value(min_val);

    if (dataObj.yaxis_scale_type != undefined && dataObj.yaxis_scale_type != null &&
            dataObj.yaxis_scale_type == 'log') {
        min_val = min_val > 0 ? min_val : 1;
        dataObj.base_value = dataObj.base_value > 0
                ? dataObj.base_value : min_val;
        yScale = pv.Scale.log(min_val,max_val ).range(0,scale_height).nice();
        dataObj.context_yScale =  pv.Scale.log(min_val,max_val ).range(0,that.context_height()).nice();
        yScale.ticks = log_ticks(yScale.domain());
    }

    dataObj.yScale = yScale;

    var log_ticks = function(domain) {
        var b = 10,
                p = Math.log(b),
                log = function(x) { return Math.log(x) / p; },
                pow = function(y) { return Math.pow(b, y); };
        n = domain[0] < 0,
                i = Math.floor(n ? -log(-domain[0]) : log(domain[0])),
                j = Math.ceil(n ? -log(-domain[1]) : log(domain[1]));
        return function() { return pv.range(i,j+1,1).map(pow);};};

    var init =  function() {
        var d1 = that.context_posX.invert(that.window.x),
                d2 =  that.context_posX.invert(that.window.x + that.window.dx),
                dd =   vq.utils.VisUtils.clone(dataObj.data_array);
        that.posX.domain(d1, d2);
        var min_val = pv.max(pv.blend(dd.map(function(a) {
            return a[dataObj.data_contents_id].filter(function(d) {
                return d[dataObj.x_column_id] < d1;});})),
                function(e) {
                    return e[dataObj.x_column_id];});
        var max_val =
                pv.min(pv.blend(dd.map(function(a)
                    { return a[dataObj.data_contents_id].filter(function(d) {
                        return d[dataObj.x_column_id] > d2;});})),
                            function(e) {
                                return e[dataObj.x_column_id];});

        dd = dd.map(function(line) {
            var obj = {};
            obj[dataObj.data_label] = line[dataObj.data_label];
            obj[dataObj.data_contents_id] =
                    line[dataObj.data_contents_id].filter(function(d){
                        return (d[dataObj.x_column_id] <= max_val && d[dataObj.x_column_id] >= min_val);
                    });
            return obj;
        });
        if (that.auto_update_scale_y()) {
            var y_max_val  =
                    pv.max(dd,function(a) { return pv.max(a[dataObj.data_contents_id],function(b) {return b[dataObj.y_column_id];});});
            var domain = dataObj.yScale.domain();
            dataObj.yScale.domain(domain[0],y_max_val);
        } else {
            dataObj.yScale.domain(that.min_y_axis_value(),that.max_y_axis_value());
        }
        return dd;
    };

    var vis = new pv.Panel()
            .top(that.vertical_padding())
            .bottom(that.vertical_padding())
            .left(that.horizontal_padding())
            .right(that.horizontal_padding())
            .width(that.width())
            .height(that.height())
            .fillStyle(null)
            .canvas(that.container());

    var wholePanel = vis.add(pv.Panel)
            .left(0)
            .top(0);

    var drawPanel = wholePanel.add(pv.Panel)
                            .width(that.visibleWidth)
                           .left(40);
    this.drawPanel = drawPanel;

    var   y_axis_label=wholePanel.add(pv.Panel)
       .top(that.focus_height/3)
       .height(that.focus_height/3)
       .left(0)
       .width(10);

    var focus = drawPanel.add(pv.Panel)
            .top(0)
            .left(0)
            .height(that.focus_height);
    var focus_click_panel = focus.add(pv.Panel);

    var plot = focus.add(pv.Panel)
            .bottom(0)
            .overflow("hidden");

    focus.add(pv.Rule)
            .left(0)
            .add(pv.Rule)
            .data(function() { return that.posX.ticks();} )
            .left(that.posX)
            .strokeStyle("#888")
            .events('none')
            .anchor("bottom").add(pv.Label)
            .text(that.posX.tickFormat);

     x_label = focus.add(pv.Panel);
    var x_rule = x_label.add(pv.Rule)
            .visible(function() { return that.mouse_x;})
            .bottom(-10)
            .height(10)
            .strokeStyle("#888")
            .events('none')
            .left(function() { return that.posX(that.mouse_x);});
    x_rule.anchor("bottom").add(pv.Label)
            .text(function() { return that.mouse_x.toFixed(2);})
            .font('4pt');

    if (dataObj.vertical_marker_array.length > 0) {
          var marker_panel = focus.add(pv.Panel)
                  .overflow("hidden")
                  .data(dataObj.vertical_marker_array);
       marker_panel.add(pv.Bar)
                       .lineWidth(2)
                       .left(function(marker) { return that.posX(marker.value);})
                       .fillStyle('rgba(240,0,0,0.6)')
                       .strokeStyle('rgba(240,0,0,0.6)')
                       .width(1)
                  .anchor('left').add(pv.Label)
                      .font('10px sans-serif')
                      .textAngle(-Math.PI/2)
                      .textAlign('center')
                      .textBaseline('bottom')
                      .textStyle('black')
                      .text(function(marker){return marker.id;});
      }

    var tracks_panel = plot.add(pv.Panel)
            .data(function() { return init();})
            .left(0)
            .width(that.visibleWidth);


    var strokeStyle = dataObj.strokeStyle,
            lineWidth  = dataObj.lineWidth,
            item = tracks_panel.add(pv.Line)
                    .data(function(d){ return d[dataObj.data_contents_id];})
                    .left(function(c) { return that.posX(c[dataObj.x_column_id]);})
                    .lineWidth(lineWidth)
                    .bottom(function(c){ return dataObj.yScale(c[dataObj.y_column_id]);})
                    .strokeStyle(function() {return strokeStyle.call(this.parent);});


    if (dataObj.notifier != undefined){
        item.cursor('pointer')
                .event('click',function(c,d){ dataObj.notifier(c,d); });
    }

    if (dataObj.legend_width){
           item
                   .event('mousemove',update_vals)
                   .event('mouseout',function() { that.show_vals = false; that.mouse_x = null; return legend;});
    }

    //only plot base_value ruler line if it falls in the current range of y-axis values
    if (dataObj.yScale.domain()[0] <= dataObj.base_value &&
            dataObj.yScale.domain()[1] >= dataObj.base_value) {
        focus.add(pv.Rule)
                .bottom(function() { return dataObj.yScale(dataObj.base_value);});
    } else { // otherwise put the ruler along the bottom.
        focus.add(pv.Rule)
                .bottom(0);
    }
    focus.add(pv.Rule)
            .data(function() { return dataObj.yScale.ticks(5);})
            .bottom(function(c) {return dataObj.yScale(c);})
            .strokeStyle('#222')
            .width(10)
            .left(0)
            .anchor('left').add(pv.Label)
            .font('4pt')
            .text(function(c,d) {return dataObj.yScale.tickFormat(c);});

    y_axis_label.add(pv.Label)
    .textAngle(-Math.PI/2)
    .font('4pt')
    .textAlign('center')
    .textBaseline('middle')
    .text(dataObj.y_axis_label);

    var x_axis_label = drawPanel.add(pv.Panel)
        .bottom(that.context_height())
        .height(15)
        .left(0)
        .width(that.visibleWidth)
    .anchor('center').add(pv.Label)
        .text(dataObj.x_axis_label)
        .font('4pt')
        .textBaseline('middle');


    /* Context panel (zoomed out). */
    var context = drawPanel.add(pv.Panel)
            .bottom(0)
            .width(that.visibleWidth)
            .left(0)
            .height(that.context_height());
    var context_panel = context.add(pv.Panel)
            .bottom(0);

    if (dataObj.vertical_marker_array.length > 0) {
          var context_marker_panel = context_panel.add(pv.Panel)
                      .data(dataObj.vertical_marker_array);
          context_marker_panel.add(pv.Bar)
                      .lineWidth(2)
                      .fillStyle('rgba(240,0,0,0.5)')
                      .left(function(marker) { return x(marker.value);})
                      .fillStyle('rgba(240,0,0,0.5)')
                      .width(1)

      }

    var context_track = context_panel.add(pv.Panel)
            .data(function(c) { return dataObj.data_array;})
            .overflow('hidden')
            .left(0);
    context_track.add(pv.Line)
            .data(function(d){ return d[dataObj.data_contents_id];})
            .left(function(c) { return x(c[dataObj.x_column_id]);})
            .bottom(function(c){ return dataObj.context_yScale(c[dataObj.y_column_id]);})
            .lineWidth(.5)
            .antialias(true)
            .strokeStyle(function() {return strokeStyle.call(this.parent);});

    context.add(pv.Rule)
            .left(0)
        /* X-axis ticks. */
            .add(pv.Rule)
            .data(that.context_posX.ticks())
            .left(that.context_posX)
            .strokeStyle("#888")
            .anchor("bottom").add(pv.Label)
            .text(that.context_posX.tickFormat);

    /* Y-axis ticks. */
    context.add(pv.Rule)
            .bottom(0);

    /* The selectable, draggable focus region. */
    context.add(pv.Panel)
            .data(function() {return [that.window];})
            .cursor("crosshair")
            .events("all")
            .event("mousedown", pv.Behavior.select())
            .event("select", function() {
        if (that.window.dx < 2) { return; }
        focus.render();})
            .add(pv.Bar)
            .left(function(d) { return d.x;})
            .width(function(d) {return d.dx;})
            .fillStyle("rgba(255, 128, 128, .4)")
            .cursor("move")
            .event("mousedown", pv.Behavior.drag())
            .event("drag", focus);

    /* The selectable, draggable focus region. */
    focus_click_panel
            .data(function() { return [that.focus_window];})
            .cursor("crosshair")
            .events("all")
            .event("mousedown", pv.Behavior.select())
            .event("selectend", function() {
        if (that.focus_window.dx < 2) { that.focus_window = {x:0,dx:0}; focus.render();
            context.render();return; }
        that.window ={x: that.context_posX(that.posX.invert(that.focus_window.x)),
            dx: that.context_posX(that.posX.invert(that.focus_window.dx)) -
                    that.context_posX(that.posX.invert(0))};
        that.focus_window = {x:0,dx:0};
        focus.render();
        context.render();})
            .add(pv.Bar)
            .left(function(d) { return d.x;})
            .width(function(d) {return d.dx;})
            .fillStyle("rgba(128, 128, 255, .4)");

    if (dataObj.legend_width){

        focus_click_panel
                .event('mousemove',update_vals)
                .event('mouseout',remove_vals);

        var legend = drawPanel.add(pv.Panel)
                .left(that.visibleWidth)
                .width(dataObj.legend_width)
                .top(10)
                .height(that.focus_height);
        var legend_item = legend.add(pv.Panel)
                .data(dataObj.data_array)
                .top(function(c) { return this.index * 12;})
                .height(10);

        legend_item.add(pv.Bar)
                .left(2)
                .width(10)
                .height(2)
                .top(2)
                .strokeStyle(function() {return strokeStyle.call(this.parent);})
       .anchor('right').add(pv.Label)
                .text(function(c) { return c[dataObj.data_label] + (that.show_vals ? ' : ' + that.current_vals[c[dataObj.data_label]] : '');})
                .textAlign('left')
                .font("10px monospace");

    }

    vis.render();

};


vq.models.ChromaVisData = function(data) {
    vq.models.VisData.call(this,data);
    this._setDataModel();
    if (this.getDataType() == 'vq.models.ChromaVisData') {
        this._build_data(this.getContents());
    } else {
        console.warn('Unrecognized JSON object.  Expected vq.models.ChromaVisData object.');
    }
};
vq.models.ChromaVisData.prototype = pv.extend(vq.models.VisData);

vq.models.ChromaVisData.prototype._build_data = function(data) {

    this._processData(data);
    this.setDataReady(true);
};


vq.models.ChromaVisData.prototype._setDataModel = function() {
    this._dataModel = [
        {label: 'width', id: 'PLOT.width', cast : Number, defaultValue: 500},
        {label: 'height', id: 'PLOT.height', cast : Number, defaultValue: 500},
        {label : 'container', id:'PLOT.container', optional : true},
        {label: 'vertical_padding', id: 'PLOT.vertical_padding', cast : Number, defaultValue: 30},
        {label: 'horizontal_padding', id: 'PLOT.horizontal_padding',cast : Number,  defaultValue: 30},
        {label: 'min_x_axis_value', id: 'PLOT.min_x_axis_value', cast : Number, defaultValue: 0},
        {label: 'max_x_axis_value', id: 'PLOT.max_x_axis_value',cast : Number,  defaultValue: 100},
        {label: 'max_y_axis_value', id: 'PLOT.max_y_axis_value',cast : Number,  defaultValue : 1},
        {label: 'min_y_axis_value', id: 'PLOT.min_y_axis_value',cast : Number,  defaultValue : 0},
        {label: 'context_height', id: 'PLOT.context_height',cast : Number,  defaultValue: 50},
        {label: 'legend_width', id: 'PLOT.legend_width',cast : Number,  defaultValue : 0},
        {label: 'auto_scale_y', id: 'PLOT.auto_scale_y',cast : Boolean,  defaultValue: false},
        {label: 'auto_update_scale_y', id: 'PLOT.auto_update_scale_y',cast : Boolean,  defaultValue: false},
        {label : 'auto_scale_x', id: 'PLOT.auto_scale_x',cast : Boolean,  defaultValue: false},
        {label : 'label', id: 'label', cast: String, defaultValue : '' },
        {label : 'type', id: 'type', cast: String, defaultValue : 'line' },
        {label : 'x_column_id' , id: 'x_column_id', cast : String, defaultValue : 'x'},
        {label : 'y_column_id' , id: 'y_column_id', cast : String, defaultValue : 'y'},
        {label : 'y_axis_label' , id: 'y_axis_label', cast : String, defaultValue : 'Intensity'},
        {label : 'x_axis_label' , id: 'x_axis_label', cast : String, defaultValue : 'Time(ms)'},
        {label : 'strokeStyle', id: 'stroke_style', cast: vq.utils.VisUtils.wrapProperty, defaultValue : pv.Colors.category10() },
        {label : 'lineWidth', id: 'line_width', cast: vq.utils.VisUtils.wrapProperty, defaultValue : vq.utils.VisUtils.wrapProperty(1) },
        {label : 'base_value', id: 'base_value', cast: Number, defaultValue : 0 },
        {label : 'yaxis_scale_type', id: 'yaxis_scale_type', cast: String, defaultValue : 'linear' },
        {label : 'notifier', id: 'notifier', cast: Function, optional : true },
        {label : 'tooltipItems', id: 'tooltip_items', defaultValue :
        {X : 'x' , Value : 'y'} },
        {label : 'data_array', id: 'data_array', defaultValue : [] },
        {label : 'vertical_marker_array', id:'vertical_marker_array', defaulValue: [] },
        {label : 'data_label', id: 'data_label', defaultValue : 'label'},
        {label : 'data_contents_id', id : 'data_contents_id', defaultValue : 'data'}
    ];
};

